<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Собери карту России из 89 регионов — мультиплеер</title>
  <style>
    :root{--bg:#0b1020;--panel:#111731;--accent:#5ee1a6;--muted:#9fb0d0;--danger:#ff6b6b}
    html,body{height:100%;margin:0;background:var(--bg);color:#e8eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .container{max-width:1200px;margin:0 auto;padding:12px}
    .card{background:var(--panel);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.3);padding:16px}
    h1{font-size:20px;margin:0 0 8px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.grid{grid-template-columns:1.6fr .4fr}}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    input,button,select{background:#0d1330;border:1px solid #2b3660;color:#e8eefc;border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1fd6a0,#0fb98a);border:0;color:#07131a;font-weight:700}
    button.ghost{background:transparent;border-color:#3b4a7a}
    button.danger{background:#ff6b6b;border:0;color:#1b0000;font-weight:700}
    .row{display:flex;gap:8px;align-items:center}
    .muted{color:#9fb0d0}
    #stage{width:100%;height:68vh;min-height:460px;background:#0a0f24;border:1px solid #223159;border-radius:12px;position:relative;overflow:hidden}
    #board{position:absolute;inset:0}
    #tray{position:absolute;top:8px;right:8px;width:min(42%,420px);max-width:46%;height:calc(100% - 16px);overflow:auto;background:rgba(10,15,36,.6);border:1px solid #243154;border-radius:12px;padding:8px}
    #tray h3{margin:0 0 6px 0;font-size:14px;color:#c8d6ff}
    #tray .note{font-size:12px;color:#9fb0d0;margin-bottom:6px}
    #leader{max-height:240px;overflow:auto;border:1px dashed #2b3b6c;border-radius:12px;padding:8px}
    .lb-row{display:flex;justify-content:space-between;padding:4px 6px;border-bottom:1px solid #1d284b}
    .lb-row.me{background:#122246}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0d1330;border:1px solid #2b3660;border-radius:999px;padding:6px 10px;font-size:12px}
    .ok{color:#0fe2a3}
    .warn{color:#ffd166}
    .err{color:#ff8585}
    .footer{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:8px}
    .small{font-size:12px}
    svg{touch-action:none}
    .piece{cursor:grab;filter:drop-shadow(0 2px 4px rgba(0,0,0,.25))}
    .piece:active{cursor:grabbing}
    .ghosted{opacity:.25}
    .target{fill:#20325f;stroke:#2b4b93;stroke-width:.6}
    .placed{fill:#4fd1a1;stroke:#0c5f49;stroke-width:.8}
    .hint{position:absolute;left:8px;bottom:8px}
  </style>
</head>
<body>
<div class="container">
  <div class="card" id="setup">
    <h1>Онлайн‑пазл: «Собери карту России»</h1>
    <p class="muted">Мультиплеер на 30+ участников с мобильных устройств. Преподаватель создаёт комнату, студенты подключаются по коду.</p>
    <div class="controls">
      <input id="name" placeholder="ФИО / Ник" style="min-width:220px"/>
      <input id="room" placeholder="Код комнаты (например, 3145)" style="width:180px"/>
      <select id="mode">
        <option value="player">Подключиться как участник</option>
        <option value="host">Создать комнату (преподаватель)</option>
      </select>
      <button id="go" class="primary">Продолжить</button>
      <button id="wipe" class="ghost">Очистить локальные данные</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="pill">Статус: <span id="status" class="warn">ожидание конфигурации Firebase</span></span>
      <span class="pill">Подсказка: положите рядом файл <code>Russian_regions_TopoJSON.topojson</code></span>
    </div>
  </div>

  <div class="grid" style="margin-top:12px">
    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:6px">
        <div class="row" style="gap:10px">
          <div class="pill">Комната: <strong id="roomLabel">—</strong></div>
          <div class="pill">Игрок: <strong id="meLabel">—</strong></div>
          <div class="pill">Поставлено: <strong id="placedLabel">0 / 89</strong></div>
          <div class="pill">Время: <strong id="timeLabel">00:00</strong></div>
        </div>
        <div class="row" style="gap:8px">
          <button id="shuffle" class="ghost">Перетасовать детали</button>
          <button id="finishDebug" class="ghost">Финиш (тест)</button>
        </div>
      </div>
      <div id="stage">
        <svg id="board"></svg>
        <div id="tray" class="card">
          <h3>Детали пазла</h3>
          <div class="note">Перетащите регионы на карту. Совпадение определяется по <em>ID региона</em> и близости к целевому центроиду — деталь «примагнитится» при верной установке.</div>
          <div id="trayPieces"></div>
        </div>
        <div class="hint pill">Подсказка: Увеличьте двумя пальцами для точного позиционирования</div>
      </div>
      <div class="footer small muted">
        <span>⚙️ Технически: D3 + TopoJSON; мобильный drag‑&‑drop, снап по центроиду. Firebase — комнаты и таблица лидеров.</span>
        <span id="loadInfo"></span>
      </div>
    </div>
    <div class="card">
      <h2 style="font-size:16px;margin:0 0 6px 0">Таблица лидеров (комната)</h2>
      <div id="leader"></div>
      <div class="row" style="margin-top:8px;gap:8px">
        <button id="resetLeader" class="danger">Сбросить результаты</button>
        <button id="copyInvite" class="ghost">Скопировать приглашение</button>
      </div>
      <p class="small muted" style="margin-top:8px">Рекомендация: преподаватель создаёт комнату и рассылает ссылку + код. Время фиксируется при установке всех 89 деталей.</p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, set, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {"apiKey": "AIzaSyCsHMYznP5Li-wNNYjxPRKiWjd1jo5UQ54", "authDomain": "russian-regions-puzzle.firebaseapp.com", "databaseURL": "https://russian-regions-puzzle-default-rtdb.firebaseio.com/", "projectId": "russian-regions-puzzle", "storageBucket": "russian-regions-puzzle.firebasestorage.app", "messagingSenderId": "352890491256", "appId": "1:352890491256:web:db8388a1fc4810cdcaf88d", "measurementId": "G-60BX1RW10B"};

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const statusEl = document.getElementById('status');
  statusEl.textContent = firebaseConfig.apiKey ? 'Firebase подключён' : 'Требуется конфигурация Firebase';
  statusEl.className = firebaseConfig.apiKey ? 'ok' : 'warn';

  const TOPO_URL = 'Russian_regions_TopoJSON.topojson';
  const TOTAL = 89;

  const board = d3.select('#board');
  const placedLabel = document.getElementById('placedLabel');
  const timeLabel = document.getElementById('timeLabel');
  const roomInput = document.getElementById('room');
  const nameInput = document.getElementById('name');
  const modeSel = document.getElementById('mode');
  const goBtn = document.getElementById('go');
  const wipeBtn = document.getElementById('wipe');
  const shuffleBtn = document.getElementById('shuffle');
  const finishDebug = document.getElementById('finishDebug');
  const leaderBox = document.getElementById('leader');
  const resetLeader = document.getElementById('resetLeader');
  const copyInvite = document.getElementById('copyInvite');
  const meLabel = document.getElementById('meLabel');
  const roomLabel = document.getElementById('roomLabel');
  const loadInfo = document.getElementById('loadInfo');

  let me = { name:'', room:'', placed:0, startAt:null, finished:false, timeMs:0 };
  let projection, path, features, svg, gBoard, gPieces, width, height;

  function fmt(ms){ const s = Math.floor(ms/1000); const m=Math.floor(s/60), ss=(s%60).toString().padStart(2,'0'); return `${m.toString().padStart(2,'0')}:${ss}` }
  function uid(){ return Math.random().toString(36).slice(2,10) }
  function saveLocal(){ localStorage.setItem('rrp.me', JSON.stringify(me)) }
  function loadLocal(){ const v = localStorage.getItem('rrp.me'); if(v){ try{ me = { ...me, ...JSON.parse(v) } }catch{} } }

  loadLocal();
  if(me.name) nameInput.value = me.name;
  if(me.room) roomInput.value = me.room;

  function roomRef(){ return ref(db, `rooms/${me.room}`) }
  function resultsRef(){ return ref(db, `rooms/${me.room}/results`) }

  async function joinRoom(isHost){
    if(!me.name || !me.room) return alert('Укажите ФИО/ник и код комнаты');
    me.id = me.id || uid();
    me.placed = 0; me.finished=false; me.timeMs=0; me.startAt=null; saveLocal();
    meLabel.textContent = me.name; roomLabel.textContent = me.room;
    if(isHost){ await update(roomRef(), { createdAt: Date.now(), host: me.name }) }
    await update(ref(db, `rooms/${me.room}/players/${me.id}`), { name: me.name, joinedAt: Date.now() });
    listenLeader();
  }

  function listenLeader(){
    onValue(resultsRef(), (snap)=>{
      const data = snap.val()||{};
      const arr = Object.values(data).sort((a,b)=>a.timeMs-b.timeMs);
      leaderBox.innerHTML = '';
      arr.forEach((r,i)=>{
        const row = document.createElement('div'); row.className='lb-row'+(r.name===me.name?' me':'');
        row.innerHTML = `<span>${i+1}. ${r.name}</span><span>${fmt(r.timeMs)}</span>`;
        leaderBox.appendChild(row);
      })
    })
  }

  resetLeader.onclick = async ()=>{ if(!confirm('Очистить таблицу лидеров этой комнаты?')) return; await remove(resultsRef()) }
  copyInvite.onclick = async ()=>{
    const url = location.href; const txt = `Подключайся к пазлу «Карта России»\\nКод комнаты: ${me.room}\\nСсылка: ${url}`;
    try{ await navigator.clipboard.writeText(txt); alert('Приглашение скопировано в буфер обмена') }catch{ alert('Скопируйте вручную:\\n'+txt) }
  }

  async function loadMap(){
    loadInfo.textContent = 'Загрузка карты…';
    const topo = await (await fetch(TOPO_URL)).json();
    const objKey = Object.keys(topo.objects)[0];
    const geo = topojson.feature(topo, topo.objects[objKey]);
    features = geo.features;
    if(features.length!==TOTAL){ console.warn('Ожидается 89 регионов, в файле:', features.length) }

    resize(); window.addEventListener('resize', resize);

    function resize(){
      const box = document.getElementById('stage').getBoundingClientRect();
      width = box.width; height = box.height;
      board.attr('width', width).attr('height', height);
      board.selectAll('*').remove();
      svg = board;
      gBoard = svg.append('g');
      gPieces = svg.append('g');

      projection = d3.geoMercator();
      path = d3.geoPath(projection);
      const fitW = width * 0.56;
      const fitH = height - 16;
      projection.fitSize([fitW, fitH], { type:'FeatureCollection', features });
      const dx = 8; const dy = 8;
      gBoard.attr('transform', `translate(${dx},${dy})`);

      gBoard.selectAll('path.target')
        .data(features, d=>d.id||d.properties?.name)
        .join('path')
        .attr('class','target')
        .attr('d', path);

      drawPieces();
    }

    loadInfo.textContent = 'Карта загружена';
  }

  function drawPieces(){
    gPieces.selectAll('*').remove();
    const ids = d3.shuffle(d3.range(features.length));

    const pieces = gPieces.selectAll('path.piece')
      .data(ids.map(i=>features[i]))
      .join('path')
      .attr('class','piece')
      .attr('fill','#9ad4ff')
      .attr('stroke','#0a2a4f')
      .attr('stroke-width',.8)
      .attr('d', path)
      .each(function(d){
        const bbox = this.getBBox();
        const ix = width*0.60 + Math.random()*(width*0.36 - bbox.width - 20);
        const iy = 20 + Math.random()*(height - bbox.height - 40);
        d._pos = { x: ix, y: iy };
        d._placed = false;
        d3.select(this).attr('transform', `translate(${ix - bbox.x}, ${iy - bbox.y})`);
      })
      .call(d3.drag()
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended)
      );

    function dragstarted(event,d){ d3.select(this).raise().attr('opacity',.9) }
    function dragged(event,d){ d3.select(this).attr('transform', `translate(${event.x},${event.y})`) }
    function dragended(event,d){ d3.select(this).attr('opacity',1);
      const [cx, cy] = path.centroid(d);
      const target = { x: cx + 8, y: cy + 8 };
      const dx = event.x - target.x; const dy = event.y - target.y;
      const dist = Math.hypot(dx, dy);
      if(dist < 24){
        const bbox = d3.select(this).node().getBBox();
        const offX = target.x - bbox.x; const offY = target.y - bbox.y;
        d3.select(this).attr('transform', `translate(${offX},${offY})`).classed('ghosted',true);
        d._placed = true; me.placed += 1; placedLabel.textContent = `${me.placed} / ${TOTAL}`; saveLocal();
        if(me.placed===1 && !me.startAt){ me.startAt = Date.now(); tickTimer() }
        if(me.placed>=TOTAL && !me.finished){ finish() }
      } else {
        const bbox = d3.select(this).node().getBBox();
        const offX = d._pos.x - bbox.x; const offY = d._pos.y - bbox.y;
        d3.select(this).attr('transform', `translate(${offX},${offY})`);
      }
    }
  }

  function tickTimer(){ if(me.finished) return; if(!me.startAt) return; me.timeMs = Date.now()-me.startAt; timeLabel.textContent = fmt(me.timeMs); requestAnimationFrame(tickTimer) }

  async function finish(){
    me.finished = true; me.timeMs = Date.now()-me.startAt; timeLabel.textContent = fmt(me.timeMs); saveLocal();
    await update(ref(db, `rooms/${me.room}/results/${me.id}`), { name: me.name, timeMs: me.timeMs, ts: Date.now() });
    alert(`Готово! Ваше время: ${fmt(me.timeMs)}`)
  }

  goBtn.onclick = async ()=>{
    me.name = nameInput.value.trim(); me.room = roomInput.value.trim(); saveLocal();
    await joinRoom(modeSel.value==='host');
    await loadMap();
  }
  shuffleBtn.onclick = ()=> drawPieces();
  finishDebug.onclick = ()=> { me.placed = TOTAL; placedLabel.textContent = `${me.placed} / ${TOTAL}`; if(!me.startAt) me.startAt=Date.now(); finish(); }
  wipeBtn.onclick = ()=>{ localStorage.removeItem('rrp.me'); location.reload() }
</script>
</body>
</html>
